## ğŸ§© RiderFlow â€“ Supabase ê¸°ì¤€ ERD

`docs/PRD.md`ì˜ ê²°ì •ì‚¬í•­(ì—‘ì…€ ì›ë³¸ ë¯¸ì €ì¥, ì—…ë¡œë“œ íˆìŠ¤í† ë¦¬ ë¯¸ì €ì¥, Supabase RLSë¡œ ìŠ¤ì½”í”„ ê°•ì œ)ê³¼
ì´ˆì•ˆ ERDì˜ â€œíšŒì‚¬ â†’ ì§€ì‚¬ â†’ ë¼ì´ë” â†’ ì •ì‚°â€ êµ¬ì¡°ë¥¼ ìœ ì§€í•˜ë©´ì„œ, **Supabase(Auth/RLS/Storage) ìš´ì˜ì— ë§ê²Œ ì œì•½Â·ì¸ë±ìŠ¤Â·ê¶Œí•œ ê¸°ì¤€ì„ ê°•í™”í•œ ì„¤ê³„**ì…ë‹ˆë‹¤.

---

## âœ… ì„¤ê³„ ì›ì¹™ (Supabase / Postgres)

- **íƒ€ì„ìŠ¤íƒ¬í”„**: `timestamptz` + `default now()`
- **PK**: ì—…ë¬´ ì—”í‹°í‹°ëŠ” `bigint generated by default as identity`, Auth ì—°ë™ì€ `uuid`
- **ê¸ˆì•¡/ê±´ìˆ˜**: ì› ë‹¨ìœ„ ì •ìˆ˜ë©´ `integer`(ìŒìˆ˜ ë°©ì§€ `check`) / ë” ì •ë°€í•˜ë©´ `numeric`
- **RLS ìŠ¤ì½”í”„**: `user_memberships`ë¥¼ ê¸°ì¤€ìœ¼ë¡œ `agency_id/branch_id` ë²”ìœ„ë¥¼ ê°•ì œ
- **ì—…ë¡œë“œ íˆìŠ¤í† ë¦¬**: **ë³„ë„ ì—…ë¡œë“œ ë©”íƒ€ í…Œì´ë¸”ì„ ë‘ì§€ ì•ŠìŒ**
  - ëŒ€ì‹  ì •ì‚° í–‰ì— `created_by`(ëˆ„ê°€ ë„£ì—ˆëŠ”ì§€) ì •ë„ë§Œ ë‚¨ê²¨ ìµœì†Œ ì¶”ì 

---

## 1ï¸âƒ£ `agencies` (íšŒì‚¬)

| ì»¬ëŸ¼ | íƒ€ì… | ì„¤ëª… |
| --- | --- | --- |
| id (PK) | bigint | íšŒì‚¬ ID |
| name | text | íšŒì‚¬ëª… |
| created_at | timestamptz | ìƒì„±ì¼ (`default now()`) |

ê´€ê³„: `agencies (1) -> (N) branches`

---

## 2ï¸âƒ£ `branches` (ì§€ì‚¬)

| ì»¬ëŸ¼ | íƒ€ì… | ì„¤ëª… |
| --- | --- | --- |
| id (PK) | bigint | ì§€ì‚¬ ID |
| agency_id (FK) | bigint | ì†Œì† íšŒì‚¬(`agencies.id`) |
| name | text | ì§€ì‚¬ëª… |
| region | text | ê´€í•  ì§€ì—­ |
| created_at | timestamptz | ìƒì„±ì¼ (`default now()`) |

ê¶Œì¥ ì œì•½/ì¸ë±ìŠ¤

- `unique (agency_id, name)` (íšŒì‚¬ ë‚´ ì§€ì‚¬ëª… ì¤‘ë³µ ë°©ì§€)
- index: `(agency_id)`

---

## 3ï¸âƒ£ `user_memberships` (ê´€ë¦¬ì/ì§ì› ê¶Œí•œ â€“ Supabase Auth ì—°ë™)

ì´ˆì•ˆì˜ `branch_managers`ë¥¼ **ê¶Œí•œ ëª¨ë¸ë¡œ ì¼ë°˜í™”**í•œ í…Œì´ë¸”ì…ë‹ˆë‹¤.  
ì‹¤ì œ ë¡œê·¸ì¸/ë¹„ë°€ë²ˆí˜¸ëŠ” Supabase Auth(`auth.users`)ê°€ ë‹´ë‹¹í•˜ë¯€ë¡œ **DBì— `password_hash` ê°™ì€ ì»¬ëŸ¼ì€ ë‘ì§€ ì•ŠìŠµë‹ˆë‹¤.**

| ì»¬ëŸ¼ | íƒ€ì… | ì„¤ëª… |
| --- | --- | --- |
| id (PK) | bigint | ë©¤ë²„ì‹­ ID |
| user_id (FK) | uuid | `auth.users.id` |
| agency_id (FK) | bigint | ì†Œì† íšŒì‚¬ |
| branch_id (FK, nullable) | bigint | ì†Œì† ì§€ì‚¬(ì§€ì‚¬ ìŠ¤ì½”í”„ì¼ ë•Œë§Œ) |
| name | text | í‘œì‹œ ì´ë¦„ |
| role | text | `agency_admin / branch_admin / staff / accounting` |
| created_at | timestamptz | ìƒì„±ì¼ (`default now()`) |

ê¶Œì¥ ì œì•½/ì¸ë±ìŠ¤

- `unique (user_id, agency_id, branch_id)`
- index: `(user_id)`, `(agency_id)`, `(branch_id)`

RLS ê¸°ì¤€ (í•µì‹¬)

- â€œì§€ì‚¬ ìŠ¤ì½”í”„ ë°ì´í„°â€ëŠ” ê¸°ë³¸ì ìœ¼ë¡œ:
  - `exists (select 1 from user_memberships m where m.user_id = auth.uid() and m.branch_id = <row>.branch_id)`
- â€œíšŒì‚¬ ì „ì²´ ê´€ë¦¬ì(agency_admin)â€ê°€ í•„ìš”í•˜ë©´:
  - `m.agency_id = <row>.agency_id` ì¡°ê±´ë„ í•¨ê»˜ ì‚¬ìš©

---

## 4ï¸âƒ£ `riders` (ë¼ì´ë” / ì •ì‚° ëŒ€ìƒ ì—”í‹°í‹°)

ë¼ì´ë”ëŠ” v1ì—ì„œ ë¡œê·¸ì¸ ì£¼ì²´ê°€ ì•„ë‹ˆë¯€ë¡œ Authì™€ ë¶„ë¦¬í•©ë‹ˆë‹¤.

| ì»¬ëŸ¼ | íƒ€ì… | ì„¤ëª… |
| --- | --- | --- |
| id (PK) | bigint | ë¼ì´ë” ID |
| name | text | ì´ë¦„ |
| phone | text | ì „í™”ë²ˆí˜¸(ì •ê·œí™”ëœ í˜•ì‹ ê¶Œì¥) |
| bank_name | text | (ì˜µì…˜) ì€í–‰ |
| bank_account | text | (ì˜µì…˜) ê³„ì¢Œë²ˆí˜¸ |
| account_holder | text | (ì˜µì…˜) ì˜ˆê¸ˆì£¼ |
| created_at | timestamptz | ìƒì„±ì¼ (`default now()`) |

ê¶Œì¥ ì œì•½/ì¸ë±ìŠ¤

- `unique (phone)` (ì •ì±…ì— ë”°ë¼ íšŒì‚¬/ì§€ì‚¬ ìŠ¤ì½”í”„ë¡œ ë°”ê¿€ ìˆ˜ë„ ìˆìŒ)
- index: `(name)`

---

## 5ï¸âƒ£ `rider_branch_map` (ë¼ì´ë” â†” ì§€ì‚¬ ë§¤í•‘)

**N:N ë§¤í•‘ì´ì RLS ê¶Œí•œ ê¸°ì¤€ í…Œì´ë¸”**ì…ë‹ˆë‹¤.

| ì»¬ëŸ¼ | íƒ€ì… | ì„¤ëª… |
| --- | --- | --- |
| id (PK) | bigint | ë§¤í•‘ ID |
| rider_id (FK) | bigint | `riders.id` |
| branch_id (FK) | bigint | `branches.id` |
| status | text | `active / inactive` |
| activated_at | timestamptz | í™œì„±í™” ì‹œê° |
| deactivated_at | timestamptz | ë¹„í™œì„±í™” ì‹œê° |
| created_at | timestamptz | ìƒì„±ì¼ (`default now()`) |

ê¶Œì¥ ì œì•½/ì¸ë±ìŠ¤

- `unique (rider_id, branch_id)`
- index: `(branch_id, status)`, `(rider_id)`

---

## 6ï¸âƒ£ `daily_settlements` (ì¼ì¼ ì •ì‚° ë°ì´í„° â€“ ì—‘ì…€ íŒŒì‹± ê²°ê³¼)

ì—‘ì…€ â€œê³„ì‚°ì‹â€ì„ ì €ì¥í•˜ì§€ ì•Šê³ , **ì—‘ì…€ì— ì´ë¯¸ ê³„ì‚°ëœ ê²°ê³¼ë§Œ ì €ì¥**í•©ë‹ˆë‹¤.  
ë˜í•œ `docs/PRD.md` ê²°ì •ëŒ€ë¡œ **ì—…ë¡œë“œ íŒŒì¼/ì—…ë¡œë“œ ì„¸ì…˜ íˆìŠ¤í† ë¦¬ëŠ” ë³„ë„ í…Œì´ë¸”ë¡œ ì €ì¥í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.**

| ì»¬ëŸ¼ | íƒ€ì… | ì„¤ëª… |
| --- | --- | --- |
| id (PK) | bigint | ì •ì‚° í–‰ ID |
| branch_id (FK) | bigint | ì§€ì‚¬ |
| rider_id (FK) | bigint | ë¼ì´ë” |
| work_date | date | ê·¼ë¬´ ì¼ì |
| delivery_count | integer | ë°°ë‹¬ ê±´ìˆ˜ |
| delivery_fee | integer | ë°°ë‹¬ë£Œ(ì´ì•¡) |
| withholding_tax | integer | ì›ì²œì„¸ |
| insurance | integer | ê³ ìš©/ì‚°ì¬ ë³´í—˜ |
| hour_insurance | integer | ì‹œê°„ì œ ë³´í—˜ |
| deduction | integer | ì°¨ê° |
| pre_paid | integer | ì„ ì§€ê¸‰ |
| commission | integer | ì •ì‚° ìˆ˜ìˆ˜ë£Œ |
| subsidy | integer | ì§€ì›ê¸ˆ |
| promo1 | integer | í”„ë¡œëª¨ì…˜1 |
| promo2 | integer | í”„ë¡œëª¨ì…˜2 |
| promo3 | integer | í”„ë¡œëª¨ì…˜3 |
| promo4 | integer | í”„ë¡œëª¨ì…˜4 |
| total_pay | integer | ì´ ì§€ê¸‰ì•¡ |
| created_by (FK, nullable) | uuid | ì—…ë¡œë“œ ì‹¤í–‰ì(`auth.users.id`) |
| created_at | timestamptz | ìƒì„±ì¼ (`default now()`) |

ê¶Œì¥ ì œì•½/ì¸ë±ìŠ¤ (ì¤‘ìš”)

- ì¤‘ë³µ ë°©ì§€(ê¶Œì¥): `unique (branch_id, rider_id, work_date)`
  - ì¬ì—…ë¡œë“œ ì •ì±…ì´ â€œë®ì–´ì“°ê¸°â€ë¼ë©´, Edge Functionì—ì„œ í•´ë‹¹ ê¸°ê°„ delete í›„ insert ë˜ëŠ” upsert ì „ëµ ì„ íƒ
- ìŒìˆ˜ ë°©ì§€(ê¶Œì¥): `check (delivery_count >= 0)` ë° ê¸ˆì•¡ ì»¬ëŸ¼ `>= 0` (ì •ì±…ì— ë”°ë¼ ì˜ˆì™¸ í—ˆìš©)
- index: `(branch_id, work_date)`, `(rider_id, work_date)`

---

## 7ï¸âƒ£ `payslips` (ì£¼ê°„ ëª…ì„¸ì„œ)

ì£¼ê°„ ë‹¨ìœ„ ì§‘ê³„ ê²°ê³¼ë¬¼(ì´ë¯¸ì§€/PDF) ë©”íƒ€ì…ë‹ˆë‹¤. íŒŒì¼ì€ Supabase Storageì— ì €ì¥í•˜ê³ , ì—¬ê¸°ì—” URL/ê²½ë¡œë§Œ ë‘¡ë‹ˆë‹¤.

| ì»¬ëŸ¼ | íƒ€ì… | ì„¤ëª… |
| --- | --- | --- |
| id (PK) | bigint | ëª…ì„¸ì„œ ID |
| branch_id (FK) | bigint | ì§€ì‚¬ |
| rider_id (FK) | bigint | ë¼ì´ë” |
| week_start | date | ì£¼ ì‹œì‘ì¼ |
| week_end | date | ì£¼ ì¢…ë£Œì¼ |
| image_url | text | ì €ì¥ëœ ì´ë¯¸ì§€ URL/ê²½ë¡œ |
| created_by (FK, nullable) | uuid | ìƒì„± ì‹¤í–‰ì |
| created_at | timestamptz | ìƒì„±ì¼ (`default now()`) |

ê¶Œì¥ ì œì•½/ì¸ë±ìŠ¤

- `unique (branch_id, rider_id, week_start, week_end)`
- index: `(branch_id, week_start)`, `(rider_id, week_start)`

---

## 8ï¸âƒ£ `message_logs` (ì¹´ì¹´ì˜¤ ì•Œë¦¼í†¡ ë°œì†¡ ë¡œê·¸)

ì„±ê³µ/ì‹¤íŒ¨ë¿ ì•„ë‹ˆë¼ â€œë¬´ì—‡ì„ ë³´ë‚´ë ¤ í–ˆê³ , ë¬´ì—‡ì„ ë°›ì•˜ëŠ”ì§€â€ê¹Œì§€ ë‚¨ê²¨ ìš´ì˜ ë””ë²„ê¹…ì´ ì‰¬ìš´ í˜•íƒœë¡œ ì„¤ê³„í•©ë‹ˆë‹¤.

| ì»¬ëŸ¼ | íƒ€ì… | ì„¤ëª… |
| --- | --- | --- |
| id (PK) | bigint | ë¡œê·¸ ID |
| branch_id (FK) | bigint | ì§€ì‚¬ |
| rider_id (FK) | bigint | ë¼ì´ë” |
| payslip_id (FK, nullable) | bigint | ëª…ì„¸ì„œ(í•´ë‹¹ ì‹œ) |
| message_type | text | ì˜ˆ: `payslip` |
| status | text | `queued / success / fail` |
| provider_message_id | text | ì¹´ì¹´ì˜¤ ë©”ì‹œì§€/ìš”ì²­ ì‹ë³„ì(ì˜µì…˜) |
| kakao_response_code | text | ì‘ë‹µ ì½”ë“œ(ì˜µì…˜) |
| request_payload | jsonb | ìš”ì²­ payload(ë¯¼ê°ì •ë³´ ìµœì†Œí™”) |
| response_payload | jsonb | ì‘ë‹µ payload |
| error_message | text | ì‹¤íŒ¨ ì‚¬ìœ (ì˜µì…˜) |
| image_url | text | ë°œì†¡ì— ì‚¬ìš©í•œ ì´ë¯¸ì§€ URL/ê²½ë¡œ(ì˜µì…˜) |
| sent_at | timestamptz | ë°œì†¡ ì‹œê° |
| created_at | timestamptz | ìƒì„±ì¼ (`default now()`) |

ê¶Œì¥ ì¸ë±ìŠ¤

- `(branch_id, sent_at desc)`
- `(status, sent_at desc)`
- `(payslip_id)`

---

## 9ï¸âƒ£ `kakao_profiles` (ì˜µì…˜: ì§€ì‚¬ë³„ ë°œì‹  í”„ë¡œí•„)

| ì»¬ëŸ¼ | íƒ€ì… | ì„¤ëª… |
| --- | --- | --- |
| id (PK) | bigint | í”„ë¡œí•„ ID |
| branch_id (FK) | bigint | ì§€ì‚¬ |
| sender_key | text | ë°œì‹  í”„ë¡œí•„ í‚¤ |
| template_code | text | í…œí”Œë¦¿ ì½”ë“œ |
| is_active | boolean | ì‚¬ìš© ì—¬ë¶€ |
| created_at | timestamptz | ìƒì„±ì¼ (`default now()`) |

ê¶Œì¥ ì œì•½/ì¸ë±ìŠ¤

- `unique (branch_id, template_code)`
- index: `(branch_id, is_active)`

---

## ğŸŒ ERD ê´€ê³„ ìš”ì•½

```text
Agency (agencies)
  â””â”€â”€ Branch (branches)
        â”œâ”€â”€ UserMembership (user_memberships)  [Auth User]
        â”œâ”€â”€ RiderBranchMap (rider_branch_map) â”€â”€ Rider (riders)
        â”œâ”€â”€ DailySettlement (daily_settlements) â”€â”€ Rider (riders)
        â”œâ”€â”€ Payslip (payslips) â”€â”€ Rider (riders)
        â”‚       â””â”€â”€ MessageLog (message_logs)
        â””â”€â”€ KakaoProfile (kakao_profiles) (optional)
```
