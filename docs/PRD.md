# RiderFlow PRD (v0.1)

## 1. 개요

- 목적: 지사별 배달 라이더 정산을 웹으로 관리·시각화하고, 명세서 생성/발송까지 이어지는 운영 효율을 높인다.
- 대상 플랫폼: Web (React Router + Supabase + TailwindCSS).
- 주요 역할: 본사 관리자, 지사 관리자, 회계/정산 담당자, 라이더(명세서 열람/알림 수신).
- 1차 범위: 대시보드, 정산 업로드, 정산 결과/기사 상세, 지난 정산 내역, 기사 관리, 지사 설정, 알림센터(로그/상태 조회 중심).

## 2. 사용자 및 문제 정의

- 본사/지사 관리자는 다양한 형식의 정산 파일을 매주 업로드하며 수동 검증/분배에 시간이 걸린다.
- 회계 담당자는 오류 여부(누락 컬럼, 포맷, 매칭 실패)를 빠르게 파악해야 한다.
- 라이더는 본인 주간/기간별 정산 내역과 명세서를 모바일 뷰에서 확인하고 싶다.

## 3. 핵심 가치 제안

- 업로드 → 자동 파싱/매칭 → 검증 → 요약/상세 확인 → 명세서 생성/발송까지 흐름을 단일 화면에서 처리.
- 데이터 신뢰성 확보(오류 감지, 매칭 기준 명시).
- 빠른 탐색(정렬/검색/필터)과 재다운로드/재업로드 지원.

## 4. 범위 (기능 요약)

- 대시보드: 요약 카드, Top 라이더, 최근 업로드 파일, 기사별 최근 정산 테이블.
- 정산 업로드: XLS/XLSX 업로드, 자동 파싱, 전화번호/이름/라이더ID 매칭, 오류 감지, 고급 컬럼 매핑(옵션), 템플릿 제공.
- 정산 결과: 전체 요약, 기사별 요약 목록, 필터(날짜/기사/금액), PDF/엑셀 다운로드, 일괄 다운로드, 기사별 상세 링크.
- 기사별 상세: 프로필, 기간별 그래프, 상세 테이블, 정산서 PDF 생성.
- 지난 정산 내역: 파일 리스트, 검색/필터, 재다운로드, 재분석.
- 기사 관리: 자동/수동 등록, 정보 수정, 정산 히스토리 연결.
- 지사 설정: 지사 프로필, 정산서 로고/컬러, 권한 관리(직원/관리자), 정산 기본 공식(공제율, 위험부담금 등).
- 알림센터: 명세서 발송 기록/상태 확인, 재발송 트리거(후순위).

## 5. 역할/권한

- 본사 관리자: 모든 지사/라이더/정산 데이터, 설정, 알림 조회·발송.
- 지사 관리자: 소속 지사 데이터(정산 업로드/검증/다운로드/발송), 기사 관리, 지사 설정.
- 회계/정산 담당자: 업로드/검증/다운로드, 오류 처리, 보고서 확인.
- 라이더: 본인 명세서/정산 내역 열람(인증 후), 알림 수신.

## 6. 데이터/ERD 매핑 (Supabase)

- 테이블: Agency, Branch, BranchManager, Rider, RiderBranchMap, DailySettlement, PayslipGenerated, MessageLog, KakaoProfile(옵션).
- 핵심 흐름: DailySettlement를 주간 그룹 → PayslipGenerated 생성 → MessageLog 기록. RiderBranchMap으로 N:N 매핑.
- 업로드 검증: 필수 컬럼(라이더ID/이름/전화번호, work_date, delivery_count, delivery_fee 등) 누락/형식 체크. 매칭 실패 시 오류 큐 기록.

## 7. UX 내비게이션 (React Router 초안)

```text
/login
/signup (옵션)
/dashboard
  /dashboard/upload
  /dashboard/results
  /dashboard/riders/:riderId
  /dashboard/history
  /dashboard/riders
  /dashboard/settings
  /dashboard/notifications
```

## 8. 주요 사용자 플로우

### 8.1 정산 업로드→검증→결과 확인

```mermaid
flowchart LR
upload[파일 업로드] --> parse[파싱/매칭]
parse --> decision{검증 오류?}
decision -- yes --> errors[오류 리스트 표시/다운로드]
decision -- no --> summarize[요약/대시보드 반영]
summarize --> resultPage[정산 결과/필터/다운로드]
resultPage --> detail[기사별 상세/PDF 생성]
```

### 8.2 명세서 생성/발송(후순위 실행 가능)

```mermaid
flowchart LR
weeklyGroup[주간 그룹핑] --> payslip[PayslipGenerated 생성]
payslip --> send[알림톡 발송]
send --> log[MessageLog 기록]
log --> notifCenter[알림센터 상태 조회/재발송]
```

## 9. 기능 요구 상세

- 업로드: Drag&Drop, 진행 상태(파싱/검증), 오류 다운로드(CSV), 컬럼 매핑 UI(옵션).
- 검증: 필수 컬럼, 타입/날짜 형식, 라이더 매칭 실패, 중복/범위 체크.
- 대시보드 카드: 총 배달 건수, 총 정산액, 기사 수, 미발송 정산표.
- Top 라이더: 수익 내림차순, 개수 설정(기본 5).
- 최근 업로드 목록: 파일명/시간/기간/처리상태/오류 여부, 정산 보기/다시 업로드.
- 기사별 테이블: 정렬(수익/건수), 검색(이름/전화번호), 페이지네이션, 상세 이동.
- 결과 페이지: 날짜/기사/금액 필터, PDF/엑셀 다운로드, 일괄 다운로드.
- 상세 페이지: 프로필, 기간별 그래프(정산액/건수), 상세 테이블, PDF 생성.
- 지난 내역: 날짜별 리스트, 검색/필터, 재다운로드, 재분석.
- 지사 설정: 로고/컬러 저장, 권한 롤(본사/지사/회계), 정산 공식 기본값 관리.
- 알림센터: 발송 기록(성공/실패, 응답코드), 재발송 버튼(후순위), 이미지 URL 확인.

## 10. 기술 요구

- 프런트: React Router로 페이지/중첩 라우트, Tailwind로 UI, 상태 관리는 React Query or Supabase hooks(쿼리/뮤테이션 캐싱).
- 백엔드: Supabase Auth(이메일/비번), RLS로 지사/사용자 권한 분리, Supabase Storage(템플릿/명세서 PDF 저장), Edge Functions(파싱/검증/명세서 생성/알림 발송 트리거).
- 파일 파싱: 서버(Edge Function)에서 XLS/XLSX 처리, 데이터만 DB 저장(원본 파일 저장 여부는 후속 결정).
- 보안: RLS, 최소 권한, 업로드 바이러스 스캔(옵션), 감사 로그.

## 11. 비기능 요구

- 성능: 업로드 5MB 기준 파싱/검증 30초 내, 대시보드 주요 쿼리 1초 내.
- 가용성: 99% 가동, 장애 시 업로드/발송 재시도 가능.
- 국제화: 기본 한국어, 통화/날짜 포맷 KR; 확장성 고려.
- 접근성: 키보드 네비게이션, 색 대비 준수.

## 12. 성공 지표 (예시)

- 업로드→검증 완료까지 평균 처리 시간
- 검증 오류 재업로드 성공률
- 명세서 발송 성공률 및 평균 딜리버리 시간
- 라이더 명세서 열람률

## 13. 가정 및 오픈 이슈

- XLS/XLSX 컬럼 표준 스키마는 템플릿으로 제공, 지사별 커스텀은 후순위 옵션.
- 알림톡 발송은 외부 연동(Kakao Biz) 준비 필요; sandbox 키/비용 검토.
- 라이더 직접 로그인 범위와 인증 수단(SMS/Email) 확정 필요.
- PDF 생성 포맷, BI/차트 라이브러리 선택은 추후 결정.
